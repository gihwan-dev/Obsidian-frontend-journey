## 1. 개요
현재 차세대 프로젝트(MaxGauge-VI)는 레거시와 동일한 `WebEnv`라는 저장소 이름을 사용하고 있지만, 데이터의 성격과 관리 방식은 완전히 다릅니다.

레거시가 WebEnv를 단순한 **'설정값 저장소'** 로 활용한 반면, 차세대는 **'DB 엔터티와 연관 관계를 맺는 비즈니스 데이터'** 를 정규화 없이 저장하고 있습니다.

이 문서는 특히 **외부 엔터티(인스턴스 등)와의 강결합으로 인해 발생하는 데이터 무결성 훼손, 권한 관리의 불가능함, 유지보수 비용 증가**에 대해 중점적으로 분석합니다.

---

## 2. 핵심 문제: 동적 엔터티와의 잘못된 결합 (차세대)

차세대 WebEnv 구조의 가장 치명적인 문제는 **실시간으로 변경될 수 있는 DB 엔터티(인스턴스 정보)를 정적인 문자열 덤프 안에 포함**하고 있다는 점입니다.

### 2-1. 깊은 중첩 구조와 카스케이딩 처리의 난해함
* **현상:** 차세대는 대시보드 → 위젯 → 위젯 상태 → 인스턴스 리스트로 이어지는 깊은 객체 구조를 하나의 JSON으로 저장합니다.
* **문제점:** 인스턴스는 런타임에 언제든지 이름이 변경되거나 삭제될 수 있는 동적인 존재입니다.
    * 만약 특정 인스턴스가 삭제된다면, WebEnv라는 거대한 텍스트 덩어리 안에서 **해당 인스턴스를 참조하고 있는 모든 부분을 찾아내어 제거**해야 합니다.
    * 단순히 키 하나를 지우는 것이 아니라, JSON을 파싱하고 트리를 순회하며 정리해야 하므로 로직이 매우 복잡하고 무겁습니다.

### 2-2. 권한(Permission) 검증과 데이터 동기화 시점의 딜레마
* **현상:** 인스턴스 리스트는 단순한 데이터가 아니라, 사용자에게 할당된 **'접근 권한'** 과 직결됩니다.
* **문제점:** 클라이언트 사이드 저장소인 WebEnv에 인스턴스 목록을 박제해버리면, **서버 측 권한 변경 사항을 반영할 방법이 모호**해집니다.
    * **사용자 권한이 회수된 경우:** WebEnv에는 여전히 해당 인스턴스 정보가 남아 있어, 사용자는 권한이 없는 데이터를 보게 되거나 조회 시 에러를 겪게 됩니다.
    * **동기화 시점의 부재:** 이를 해결하려면 대시보드 진입 시점마다 서버의 실제 권한 정보와 WebEnv 저장 값을 대조(Diff)해야 합니다.
    * **유지보수 불가능:** "매번 진입 시 비교 → 다르면 WebEnv 업데이트 → 재저장"의 사이클을 클라이언트에서 수행하는 것은 성능 저하뿐만 아니라, 로직의 복잡도를 감당할 수 없는 수준으로 만듭니다.

---

## 3. 레거시 시스템이 안전했던 이유

레거시 시스템은 이러한 '연관 관계'의 문제를 구조적으로 회피하고 있습니다.

### 3-1. 연관 관계의 부재 및 ID 기반 키 관리
* **독립적 데이터:** 레거시 WebEnv의 대부분은 테마, 언어, 알람 소리 등 외부 DB 상태와 무관한 독립적인 값들입니다.
* **인스턴스 처리 방식:** 인스턴스별 설정이 필요한 경우에도, 인스턴스 객체를 통째로 넣는 것이 아니라 **인스턴스 ID를 최상위 키(Key)로 사용**하여 분리 저장합니다. (`EXEM.webEnv.instance[ID]`)

### 3-2. 손쉬운 카스케이딩과 서버 제어
* **삭제의 용이성:** 인스턴스가 삭제되면 해당 ID를 가진 키만 삭제하면 끝입니다. 깊은 탐색이나 파싱이 필요 없습니다.
* **백엔드 개입 가능:** 구조가 단순하므로, 필요하다면 백엔드에서도 SQL 등으로 특정 인스턴스 ID를 포함한 WebEnv 데이터를 일괄 정리하는 것이 가능합니다. 차세대처럼 JSON 내부를 뜯어볼 필요가 없기 때문입니다.

---

## 4. 결론 및 제언

현재 차세대의 WebEnv 구조는 **"변화하는 데이터(DB 엔터티)를 변화하지 않는 저장소(WebEnv)에 스냅샷으로 박제"** 함으로써 스스로 정합성 오류를 만들어내고 있습니다.

인스턴스와 같이 **1) 수명 주기가 다르며 2) 권한 체크가 필요하고 3) 다른 엔터티와 관계를 맺는 데이터**는 절대 WebEnv와 같은 비정형 텍스트 저장소에 포함되어서는 안 됩니다.

**해결 방향:**
1.  **참조(Reference) 저장 원칙:** WebEnv에는 객체 전체가 아닌, 변하지 않는 식별자(ID)만 저장해야 합니다.
2.  **런타임 조인:** 실제 인스턴스 정보(이름, IP, 상태 등)와 권한 검증은 화면을 렌더링하는 시점에 서버로부터 최신 데이터를 받아와 ID와 매핑하여 보여줘야 합니다.
3.  **저장소 분리:** 가능하다면 대시보드 및 위젯 구성 정보는 정규화된 RDB 테이블로 이관하여 DB 수준의 무결성(Foreign Key 등)을 보장받아야 합니다.
4. **스토어 분리:** 다른 엔터티와 연관 관계가 필요한 위젯, 대시보드에 대한 데이터는 RDBMS에서 관리하게 하고 WebEnv에는 "레이아웃"과 관련된 데이터만 저장.
