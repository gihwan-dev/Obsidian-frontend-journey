AI 코드 리뷰에서 적합한 컨텍스트를 제공할 때 어려운 것들이 있다. 아래는 특히 어려운 3가지다:

### 1. The Goldilocks problem for AI agents
- **너무 적은 컨텍스트**는 환각(hallucination)이 발생시킨다 -- AI가 미비된 정보에 대해서 옳바르지 않은 추정을 하게 된다.
- **너무 많은 연관되지 않은 맥락**은 중요하지 않은 측면에 AI가 집중하게 하거나 방대한 정보에 압도되게 만들어 중요한 맥락이 불필요한 정보에 의해 흐려지게 만든다.
- **적당한 컨텍스트**는 잡음 없이 정확한 정보를 제공하게 해준다.

### 2. Token-by-token processing
사람은 문서를 빠르게 훑어보며 중요한 부분을 머릿속으로 우선순위에 따라 파악할 수 있지만, AI 모델은 정보를 토큰 단위로 처리하기 때문에 모든 텍스트에 동일한 비중을 둔다. 만약 PR의 모든 코드 변경 사항을 프롬프트에 넣으면, AI가 중요하지 않은 부분에 집중하고 주요 이슈를 놓칠 수 있다. 그래서 맥락을 신중하게 선별하는 것이 중요하다. 중요한 변경 사항에 우선순위를 두고, 중요하지 않은 것은 제외해야한다.

### 3. Context window limitations
가장 발전된 AI 모델조차도 한 번에 처리할 수 있는 텍스트의 양, 즉 컨텍스트 윈도우가 한정되어 있다. 이러한 한계 때문에, 특히 대규모 코드베이스나 복잡한 풀 리퀘스트에서는 전략적으로 맥락을 선택하는 것이 매우 중요하다.

## 컨텍스트 엔지니어링에 대한 코드 래빗의 접근 방식
![[Pasted image 20250725125718.png]]

이러한 문제들을 해결하고 일관되게 높은 품질의 코드 리뷰를 제공하기 위해, 우리는 정교하고 비선형적인 파이프라인을 활용해 맥락을 수집, 필터링, 구조화한다. 이 과정은 AI가 맥락을 최대한 잘 이해할 수 있도록 설계되었다. 위의 다이어그램은 우리가 맥락 준비 과정에서 활용하는 수십 가지 출처 중 일부만을 보여준다.

우리의 컨텍스트 준비 과정은 풀 리퀘스트 자체에 대한 가장 관련성 높은 정보를 추출하는 것에서 시작한다:

- **메타데이터**: 코드 변경의 "이유"를 파악하기 위해 PR 제목, 설명, 영향을 받은 커밋 범위 등 필수 데이터를 수집한다.
- **차등 분석**: 점진적 리뷰의 경우, 마지막 리뷰 이후의 정확한 변경 사항을 계산해 에이전트가 새롭거나 수정된 부분에만 집중할 수 있도록 한다.
- **경로 필터링**: 의미 있는 코드 변경과 생성된 자산이나 의존성 파일과 같은 부수적인 파일을 구분해, AI가 진짜 중요한 부분에 집중하도록 한다.

### 다양한 소스로 부터 생성된 지식을 통합하기
![[Pasted image 20250725130335.png]]

훌륭한 코드 리뷰를 위해서는 현재의 변경 사항만 따로 보는 것 이상이 필요합니다. 다음 단계로, 더 넓은 기술적·비즈니스적 맥락을 이해하는 작업을 진행합니다:

- **과거 학습 내용:** 우리는 벡터 데이터베이스를 활용해 에이전트가 과거 리뷰에서 학습한 내용을 저장합니다. 이를 통해 시스템이 관련 피드백 패턴과 사용자 선호도를 기억하고, 이를 반영해 리뷰 코멘트를 구성할 수 있습니다.
- **PR 의도 분석**: PR 설명과 관련 이슈를 분석해 변경의 근본적인 목적을 추출함으로써, CodeRabbit의 리뷰가 개발자의 목표와 일치하도록 합니다.
- **코드 그래프 분석**: 코드 의존성의 그래프 표현을 만들어, AI가 파일 간의 상호 관계를 이해할 수 있도록 하여, 아키텍처적 영향을 고려한 리뷰가 가능하게 합니다.

### 전략적으로 맥락 조합하기
![[Pasted image 20250725130718.png]]

리뷰에 필요한 모든 원시 정보를 수집한 후, AI 에이전트에게 전달할 프롬프트가 최적화되도록 구성한다.

### 프롬프트 엔지니어링![[Pasted image 20250725130833.png]]

리뷰 파이프라인의 다음 단계는 AI를 위한 완벽한 프롬프트를 만드는 것이다. 우리는 프롬프트에서 코드와 맥락의 비율을 평균 1:1로 맞추고 있는데, 이는 맥락이 얼마나 중요한지를 보여준다.

- **수준에 맞는 프롬프트**: 파일의 복잡성과 중요도에 따라 리뷰의 깊이를 조정한다. 기본적인 확인부터 심층적인 아키텍처 분석까지, 복잡도에 따라 서로 다른 프롬프트와 모델을 사용한다.
- **구조화된 리뷰 가이드라인**: 명확한 지침을 통해 AI 에이전트가 각 상황에서 가장 가치있는 피드백에 집중할 수 있도록 한다. 이는 과거에 유용했던 리뷰 코멘트 데이터를 기반으로 한다.
- **맥락 강화**: 프롬프트에는 프로젝트의 코딩 표준, 패턴, 과거의 인사이트 등 관련 정보가 포함되어, AI가 회사별 모범 사례를 따르도록 유도한다.
- **맥락 선택**: 이전 단계에서 준비된 맥락을 마지막으로 한 번 더 검토해 불필요한 정보를 걸러낸다.

### 검증 
![[Pasted image 20250725131137.png]]

우리 리뷰 프로세스의 마지막 단계는 검증 시스템이다. 이 시스템은 AI 기반의 품질 보증 계층으로, 리뷰 코멘트를 자동으로 검증하고 개선한다. AI 리뷰어가 자신의 결과를 다시 한 번 확인해야 할 때 이 시스템이 작동한다.

### 컨텍스트 엔지니어링이 리뷰 퀄리티 상승에 미치는 영향
![[Pasted image 20250725131241.png]]

우리의 정교한 컨텍스트 엔지니어링 준비 파이프라인은 리뷰 품질에 직접적으로 실질적인 이점을 가져다준다. 그 예시는 다음과 같다:

- **오탐(false positive) 감소**
	AI에 적절한 맥락을 제공함으로써, 팀의 코딩 표준에 맞지 않는 함수 호출 변경과 같이 개발자의 시간을 낭비하는 무관하거나 잘못된 제안을 크게 줄일 수 있다. 이 시스템은 프로젝트별 규칙을 이해하고, 의도적으로 사용된 패턴을 문제로 잘못 지적하지 않는다.
- **더 깊은 아키텍처적 통찰**
	코드 간의 관계와 프로젝트 구조에 대한 더 많은 정보를 바탕으로, CodeRabbit은 단순 린트 도구나 패턴 매칭으로는 놓칠 수 있는 아키텍처적 문제를 식별할 수 있다. 예를 들어, 많은 고객들이 CodeRabbit이 PR 변경 사항이 코드베이스 내 다른 의존성 영향을 줄 때 이를 잘 짚어낸다고 평가한다.
- **일관된 모범 사례 적용**
	과거의 학습 내용과 팀별 지식을 반영해, 모든 리뷰에서 코딩 표준과 모범 사례를 일관되게 적용한다. 최근에는 선호하는 코딩 에이전트에서 코딩 가이드라인을 가져올 수 있는 기능도 추가되어, 팀이 가이드라인을 공유하기가 더욱 쉬워졌다.
- **시간이 지날수록 향상되는 학습**
	우리의 접근 방식은 시스템이 리뷰를 거듭할수록 프로젝트별 인사이트가 쌓여, 미래의 리뷰가 더욱 가치 있게 이루어지도록 한다.


## 좋은 컨텍스트 엔지니어링을 중요성
컨텍스트는 단순히 LLM(대형 언어 모델)을 위한 기술적 요구사항이 아니라, 효과적인 AI 에이전트에 반드시 필요한 요소다. 컨텍스트를 신중하게 수집, 필터링, 구조화, 그리고 제시함으로써, CodeRabbit은 단순히 코드를 리뷰하는 데 그치지 않고, 코드의 복잡한 맥락까지 이해해 개발자의 생산성을 높이고, 코드를 더 견고하게 만들며, 팀의 효율성을 높일 수 있는 인사이트를 제공한다. 이는 현재 AI 코딩 에이전트들이 많은 'AI 슬롭(불필요하거나 부정확한 결과물)'을 생성하는 경향이 있기 때문에 더우 중요해지고 있다.

이것은 AI 코드 리뷰를 위한 컨텍스트 엔지니어링의 시작에 불과하다. 우리는 리뷰 품질을 높이기 위해 항상 접근 방식을 개선하고 있다. 모델의 역량이 계속 확장됨에 따라, 앞으로 훨씬 더 많은 것을 할 수 있게 될것이다.
