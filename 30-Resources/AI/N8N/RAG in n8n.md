RAG(검색 증강 생성)은 외부 데이터 소스를 언어 모델과 통합해 AI 응답 품질을 상승시키는 기술이다. 모델이 내부에 학습된 데이터에만 의존하는 대신, RAG 시스템은 관련 문서를 검색해 이에 기반한 응답을 생성한다. RAG 워크플로우는 외부 데이터를 효율적으로 검색하기 위해 벡터 저장소를 사용한다.

## 벡터 저장소란?
벡터 저장소는 텍스트, 이미지 또는 기타 데이터를 수치로 표현하고 고차원 벡터를 저장하고 검색하도록 설계된 특수한 데이터베이스다. 문서를 업로드하면, 벡서 스토어는 문서를 여러 조각으로 나누고 각 조각을 임베딩 모델을 사용해 벡터로 변환한다.

이렇게 생성된 벡터를 통해서 키워드 일치가 아닌 의미 기반의 유사도 검색을 수행할 수 있다. 이러한 방식 덕분에 벡터 스토어는 방대한 지식 집합에서 정보를 검색하고 추론해야 하는 RAG 및 기타 AI 시스템의 강력한 기반이 된다.

## n8n에서 RAG를 사용하는 방법
### 벡터 저장소에 데이터 삽입하기
에이전트가 저장소에 접근하기 전에, 우리는 벡터 저장소에 데이터를 업로드 해야한다.
1. 소스 데이터를 가져오는데 필요한 노드를 추가한다.
2. 벡터 스토어 노드(예: Simple Vector Store)를 삽입하고, Insert Documents 작업을 선택한다.
3. 텍스트를 벡터 임베딩으로 변환하는 임베딩 모델을 선택한다.
4. Default Data Loader 노드를 추가해 콘텐츠를 여러 조각으로 분류한다. 기본 설정을 사용하거나 직접 분할 방식을 정의할 수 있다.
	1. Character Text Splitter: 글자 수 기준으로 분할한다.
	2. Recursive Character Text Splitter: 마크다운, HTML, 코드 블록 또는 단순 문자 기준으로 재귀적으로 분할한다(대부분의 경우 권장)
	3. Token Text Splitter: 토큰 수 기준으로 분할한다.
5. (선택 사항)각 조각에 메타데이터를 추가해 맥락을 풍부하게 하고, 나중에 더 나은 필터링이 가능하도록 한다.

### 데이터 쿼링
두 가지 방식을 통해 데이터를 쿼리할 수 있다: 에이전트를 사용하거나 직접적으로 노드를 사용할 수 있다.

### 에이전트 사용하기
1. 에이전트를 추가한다.
2. MCP툴로 백터 저장소를 추가하고, 설명을 추가해 에이전트가 이해할 수 있게 해서 사용할 수 있다:
	1. 반환해야 하는 청크 갯수 제한 값을 설정한다.
	2. 각 청크에 대한 추가적인 정보를 포함하기 위해 메다데이터 포함을 허용한다.
3. 데이터를 추가할 때 사용했던 임베딩 모델과 동일한 모델을 추가한다.

> [!Note] Pro tip
> 토큰 갯수를 최적화 하기 위해서, 우선 Vector Store Question Answer tool 을 사용해 관련된 데이터를 모을 수 있다.

### 노드를 직접적으로 사용하기
1. 벡터 저장소 노드를 추가하고 **Get Many** 오버페이션을 선택한다.
2. query 또는 prompth를 입력한다.
	1. **제한**을 설정한다.
	2. **Include Metadata**를 허용한다.

## FAQs
### 내 use case에서 가장 좋은 텍스트 분리 방식은 무엇인가요?
어떤 데이터를 저장하느냐에 따라 달려있다:
- 작은 청크(200 ~ 500)는 세밀한 검색에 적합하다.
- 큰 청크는 더 많은 맥락을 담을 수 있지만, 정보가 희석되거나 불필요한 내용이 섞일 수 있다.

AI가 청크의 맥락을 잘 이해하려면 적절한 오버랩(겹침) 크기를 사용하는 것이 중요하다. 그래서 마크다운이나 코드 블록 단위로 분할하는 방법이 청크의 품질을 높이는데 도움이 될 수 있다.

또 다른 좋은 방법은 각 청크에 더 많은 맥락(예: 해당 청크가 어떤 문서에서 왔는지 등)을 추가하는 것이다. 더 자세한 내용은 [[Introducing Contextual Retrieval]] 글을 참고하면 된다.

#n8n
