렌더 트리를 구축하려면 각 렌더 객체의 시각적 속성에 대한 계산이 필요한데 이는 각 요소의 스타일 속성을 계산함으로써 처리된다.

스타일을 계산하는 일에는 몇가지 어려움이 있다.

1. 수많은 스타일 속성들로 인한 메모리 문제
2. 각 요소에 할당된 규칙을 찾는 것의 성능 문제.
3. 규칙 적용을 위한 계층 구조 파악시의 복잡성

## 스타일 정보 공유

웹킷에서 노드가 스타일 객체를 참조할 때 이 객체를 일정 조건 아래 공유할 수 있다. 노드가 형제이거나 사촌일 때 공유하며 다음과 같은 조건일 때 공유할 수 있다.

1. 동일한 마우스 반응 상태를 가진 요소여야 한다.
2. 아이디가 없는 요소여야 한다.
3. 태그 이름이 일치해야 한다.
4. 클래스 속성이 일치해야 한다.
5. 지정된 속성이 일치해야 한다.
6. 링크 상태가 일치해야 한다.
7. 초점(focus) 상태가 일치해야 한다.
8. [[속성 선택자]]의 영향을 받는 요소가 없어야 한다.
9. 인라인 스타일 속성이 없어야 한다
10. 문서 전체에서 형제 선택자를 사용하지 않아야 한다.

## 파이어폭스 규칙 트리

파이어폭스는 더 간편한 스타일 계산을 위한 두 가지 트리, 규칙 트리와 스타일 컨텍스트 트리가 있다.

**스타일 컨텍스트 트리**
- DOM 트리와 비슷한 구조
- 특정 노드에 대한 계산된 스타일 정보를 올바른 순서([[스타일 시트 계단식 순서]])에 따라 구체적인 값의 형태로 저장
- 부모-자식 관계가 중요 (스타일 상속 때문)
- 현제 노드들 간의 순서는 중요하지 않음

```예시
<div> -> [div의 스타일 컨텍스트]
	<p> -> [p의 스타일 컨텍스트]
		<span> -> [span의 스타일 컨텍스트]
```

**규칙 트리**
- CSS 규칙들의 매칭 결과를 저장
- 메모리 최적화를 위해 공통된 스타일 규칙을 공유
- 트리의 깊이는 매칭된 규칙의 수에 따라 결정
- 필요할 때 마다 노드가 추가된다.

```html
div { color: blue } [규칙 노드 1]
div p { font-size: 12px } [규칙 노드 2]
p.highlight { color: red } [규칙 노드 3]
```

![[Pasted image 20241127101110.png]]

## 규칙 트리를 사용하여 스타일 컨텍스트 계산

규칙 트리와 스타일 컨텍스트를 사용해 계산하는 방식을 살펴보자. 다음과 같은 HTML과 CSS가 있다고 가정해보자.

```html
<html>
  <body>
    <div class="err" id="div1">
      <p>
        this is a <span class="big"> big error </span>
        this is also a
        <span class="big"> very  big  error</span> error
      </p>
    </div>
    <div class="err" id="div2">another error</div>
  </body>
</html>
```

```css
div {margin: 5px; color:black} --> 규칙 1번
.err {color:red} --> 규칙 2번
.big {margin-top:3px} --> 규칙 3번
div span {margin-bottom:4px} --> 규칙 4번
#div1 {color:blue} --> 규칙 5번
#div2 {color:green} --> 규칙 6번
```

규칙 트리는 다음과 같이 생성된다. (노드이름: 규칙 번호)

![[Pasted image 20241129174558.png]]

컨텍스트 트리는 다음과 같다. (노드 이름: 노드가 가리키는 규칙 노드)
![[Pasted image 20241129174505.png]]

파싱을 가정하며 순차적으로 따라가보자.

## 1. `<div class="err" id="div1">` => 규칙 1, 2, 5번에 부합

![[Pasted image 20241127110741.png]]

## 2. `<span class="big">`을 만난 상황 => 3, 4번 규칙과 부합

![[Pasted image 20241127110856.png]]

## 3. `<span class="big">`을 다시 만난 상황 => 3, 4번 규칙과 부합

![[Pasted image 20241127110923.png]]

이런 형태로 특정 요소의 스타일 컨텍스트를 계산할 때 먼저 규칙 트리에서 경로를 계산하거나 기존 경로를 사용한다. 이후 경로의 규칙을 적용하여 새 스타일 컨텍스트의 구조체를 채운다.

이렇게 하면 구조체가 "상속" 유형인 경우 컨텍스트 트리의 상위 구조체를 가리켜 공유할 수 있고, 동일한 트리 노드를 가리키는 동위 또는 형제가 있는 요소는 **전체 스타일 컨텍스트**를 공유할 수 있다.
