브라우저의 주소 표시줄에 URL을 입력하면 브라우저가 인터넷에서 데이터를 가져와서 페이지를 표시한다.

## 브라우저 프로세스에서 시작

[[브라우저 아키텍처]]에서 `브라우저 프로세스`가 탭 영역 밖에 있는 모든 부분을 제어한다고 설명했다.` 브라우저 프로세스`에는 다양한 **스레드**가 있다.

- **UI 스레드**: 브라우저의 버튼과 입력란을 그린다.
- **네트워크 스레드**: 인터넷에서 데이터를 가져오기 위해 네트워크 스택을 다룬다.
- **스토리지 스레드**: 파일에 대한 접근을 제어한다.

## 기본적인 네비게이션

### 1단계: 입력 처리

사용자가 주소 표시줄에 UI를 타이핑 하면:

1. 입력되는 내용이 검색어인지 URL인지 확인한다. (크롬에서 주소 표시줄은 검색창이기도 하다.)
2. 입력 내용을 파싱해서 검색 엔진으로 이동할지 요청한 사이트로 이동할지 결정한다.

### 2단계: 내비게이션 시작(URL인 경우)

사용자가 **Enter** 키를 누르면:

1. **UI 스레드**가 네트워크 호출을 시작한다(**네트워크 스레드**에게 요청이 필요함을 알림).
2. 로딩 스피너가 표시된다.
3. **네트워크 스레드가 요청**에 대한 [[DNS Lookup]] , [[TCP Handshake]], [[TLS 협상]]과 같은 과정을 거쳐 요청을 처리한다.
4. **네트워크 스레드**가 `301`과 같은 리디렉션 응답을 받으면 새로운 URL 요청을 한다.

### 3단계: 응답 읽기

페이로드가 들어오면 **네트워크 스레드**는 필요에 따라 스트림의 처음 몇 바이트를 확인해 어떤 형식의 데이터인지 확인한다. `Content-Type` 헤더를 통해 알 수 있는데, 정보가 없거나 잘못된 정보가 있을 수 있다. 이대 `MIME 스니핑`을 실행해 실제 형식을 알아낸다.

응답 종류에 따라 다른 단계로 넘어간다.

- **렌더러 프로세스가 다룰 수 있는 형식일 때(PDF, HTML 등):** 데이터를 **렌더러 프로세스**에 전달하는 단계로 넘어간다.
- **그렇지 않을 때:** 다운로드 요청이므로 다운로드 매니저에 데이터를 전달하는 단계로 넘어간다.

이 단계는 또한 [[Safe Browsing]]의 검사가 실행되는 단계이다. 안전하지 않은 사이트라면 **네트워크 스레드**는 경고 페이지를 표시하라고 알린다.

### 4단계: 렌더러 프로세스 찾기

모든 검사가 끝나고 사이트 이동이 필요하다고 확신하게 되면 **네트워크 스레드**는 **UI 스레드**에 데이터가 준비되었음을 알린다. **UI 스레드**는 웹 페이지의 렌더링을 수행할 [[렌더러 프로세스]]를 찾는다. 이동될 사이트에 대해서 캐싱되어 있다면 `렌더러 프로세스`를 먼저 찾거나 네트워크 요청과 동시에 `렌더러 프로세스`를 시작할 수 있다.

![[Pasted image 20241128122902.png]]

### 5단계: 내비게이션 실행

데이터와 `렌더러 프로세스`가 준비되었다면 내비게이션을 실행하도록 `브라우저 프로세스`에서 `렌더러 프로세스`로 메시지를 전송한다. 또한 `렌더러 프로세스`가 HTML 데이터를 계속 수신할 수 있도록 `브라우저 프로세스`는 데이터 스트림을 전달한다. `렌더러 프로세스`에서 내비게이션이 실행되었다는 것을 `브라우저 프로세스`가 확인하고 나면 내비게이션이 완료되고 문서 로딩 단계가 시작된다.

이 시점에 
1. 주소 표시줄이 업데이트
2. 보안 표시와 사이트 설정 UI도 새 페이지의 사이트 정보를 반영해 갱신
3. 탭에 대한 세션 기록이 업데이트
4. 세션 기록이 디스크 드라이브에 저장
된다.

## 다른 사이트로 내비게이션

주소 표시줄에 다른 URL을 다시 입력하면 어떻게 될까? `브라우저 프로세스`는 동일한 단계를 거쳐 다른 사이트로 이동을 처리한다. 하지만 그전에 렌더링된 사이트에서 `beforeunload` 이벤트를 확인해야 한다.

`beforeunload` 이벤트는 탭을 닫거나 이동하려고 할 때 "이 사이트를 떠나시겠습니까?" 라는 경고창을 만들 수 있다.

링크를 클릭하거나, JS를 통해 `window.location` 값이 변경되면 `렌더러 프로세스`는 `beforeunload` 이벤트 핸들러를 확인한다. 이후 브라우저의 기본적인 네비게이션 과정을 거친다. 차이점은 다른 사이트로 이동하는 내비게이션은 `unload` 같은 이벤트를 처리하기 위해 `렌더러 프로세스`가 유지된다.

## 서비스 워커

서비스 워커는 앱의 코드에 네트워크 프락시를 작성할 수 있는 수단이다. 서비스 워커를 통해 웹 개발자는 무엇을 로컬 캐시에 저장할지, 언제 네트워크에서 새 데이터를 가져올지 제어할 수 있다. 워커가 캐시에서 페이지를 로드하도록 설정되었다면 네트워크에서 데이터를 가져올 필요가 없다.

서비스 워커가 등록되면 [[서비스 워커의 범위]]는 참조를 위해 유지된다. 내비게이션이 발생하면 네트워크 스레드가 도메인을 통해 등록된 서비스 워커를 찾는다. 만약 등록되었다면, UI 스레드는 서비스 워커 코드를 실행시킨 렌더러 프로세스를 찾는다. 서비스 워커는 캐쉬로부터 데이터를 불러올 수 있고, 네트워크로 부터 데이터를 불러오도록 강제할수도 있다. 또는 아예 새로운 네트워크에 요청을 발생시킬수도 있다.

## 탐색 미리 로드

브라우저 프로세스와 렌더러 프로세스 간의 왕복으로 지연이 발생할 수 있다. 서비스 워커가 결국 네트워크 데이터를 요청하기로 결정하면 [[탐색 미리 로드]]는 이 작업의 속도를 높여줄 수 있다.