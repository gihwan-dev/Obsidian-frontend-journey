# 구현 계획: 디자인 검증 자동화 (Design Check System)

> Figma 스크린샷 vs Storybook 렌더링 컴포넌트 스크린샷을 비교하여 디자인 검증 정확도를 높이는 3-SKILL 시스템

---

## 1. 목표

개발 중 Figma 디자인과 실제 구현체의 시각적 차이를 **정량적(pixelmatch) + 정성적(Claude 시각 분석)** 으로 비교하여, 디자인 QA를 자동화한다.

---

## 2. 아키텍처 개요

```
사용자 입력: /design-check <Figma URL> <컴포넌트 경로>
                          │
          ┌───────────────┼───────────────┐
          ▼               ▼               ▼
   ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
   │ Figma MCP   │ │ story-gen   │ │ screenshot  │
   │ (get_screen │ │ SKILL       │ │ SKILL       │
   │  shot)      │ └──────┬──────┘ └──────┬──────┘
   └──────┬──────┘        │               │
          │               ▼               │
          │        Story 파일 생성         │
          │        (__screenshots__/)      │
          │               │               │
          │               └───────────────┘
          │                       │
          │                       ▼
          │              Storybook 캡처
          │              (Playwright)
          │                       │
          ▼                       ▼
   Figma PNG              구현 PNG
          │                       │
          └───────┬───────────────┘
                  ▼
         ┌──────────────┐
         │ 비교 엔진     │
         │ pixelmatch   │
         │ + Claude     │
         └──────┬───────┘
                ▼
         Markdown 보고서
```

---

## 3. 기존 인프라 활용

| 기존 자산 | 활용 방법 |
|-----------|-----------|
| `scripts/vrt/compare.ts` | pixelmatch 비교 로직 참조 |
| `pixelmatch@7.1.0` | 픽셀 비교 엔진 |
| Playwright | Storybook 스크린샷 캡처 |
| `msw-storybook-addon` | API 모킹 자동 적용 |
| `.storybook/preview.tsx` | 기존 decorator 상속 |
| Figma MCP | `get_screenshot`, `get_design_context`, `get_variable_defs` |
| `tsx@4.19.2` | 스크립트 직접 실행용 |
| `vitest@3.0.6` | 스크린샷 캡처 테스트 래퍼 |

---

## 4. 변경 파일 목록

| 파일 | 작업 | 설명 |
|------|------|------|
| `scripts/capture-figma-screenshot.ts` | 생성 | Figma REST API 기반 스크린샷 + 메타데이터 저장 |
| `scripts/capture-screenshot.ts` | 생성 | Playwright 기반 캡처 스크립트 + `--container-width` 옵션 |
| `scripts/compare-screenshots.ts` | 생성 | pixelmatch 비교 스크립트 + 크기 불일치 경고 |
| `.claude/skills/story-generator/SKILL.md` | 생성 | Story 자동 생성 SKILL |
| `.claude/skills/component-screenshot/SKILL.md` | 생성 | 스크린샷 캡처 SKILL |
| `.claude/skills/design-check/SKILL.md` | 생성 | 오케스트레이션 SKILL |
| `.storybook/main.ts` | 수정 | `__screenshots__/` 경로 추가 |
| `.gitignore` | 수정 | `artifacts/screenshots/` 추가 |

---

## 5. Phase별 구현

### Phase 1: 스크린샷 캡처 스크립트

#### 1-1. Figma 스크린샷 캡처

**파일**: `scripts/capture-figma-screenshot.ts`

Figma REST API를 통해 노드를 캡처하고 **크기 메타데이터**를 함께 저장합니다.

**출력물**:
- `{output}.png` — 실제 스크린샷 이미지
- `{output}.meta.json` — 크기 메타데이터

```json
{
  "bbox": { "width": 632, "height": 48 },   // CSS px (논리적 크기)
  "image": { "width": 1264, "height": 96 }, // 실제 PNG 픽셀 크기
  "scale": 2
}
```

**핵심 원칙**: Figma가 생성한 비트맵의 물리적 크기를 **절대 기준**으로 삼고, Storybook 환경을 이에 맞춥니다.

#### 1-2. Storybook 스크린샷 캡처

**파일**: `scripts/capture-screenshot.ts`

```typescript
interface CaptureOptions {
  storyId: string;          // Storybook story ID
  output: string;           // 출력 PNG 경로
  width?: number;           // 뷰포트 너비
  height?: number;          // 뷰포트 높이
  containerWidth?: number;  // [신규] Figma bbox.width를 주입
  storybookUrl?: string;    // 기본: http://localhost:6006
  waitMs?: number;          // 안정화 딜레이 (기본: 500)
}
```

**핵심 로직**:
1. Storybook 포트 접속 확인 → 미실행 시 자동 실행
2. Playwright Chromium headless 실행
3. iframe URL 접속: `{storybookUrl}/iframe.html?id={storyId}&viewMode=story`
4. `networkidle` + 딜레이 대기
5. **[신규]** `--container-width` 지정 시 CSS 주입:
   ```css
   #storybook-root > *:first-child {
     width: {containerWidth}px !important;
     box-sizing: border-box;
     overflow: hidden;
     margin: 0;
   }
   ```
6. **[신규]** `document.fonts.ready` 대기 + `requestAnimationFrame` 리플로우 보장
7. `#storybook-root > *` 요소 캡처
8. PNG 저장

**설계 결정**:
- width만 주입, height는 주입하지 않음 — height 차이는 실제 구현 차이이므로 diff로 잡혀야 함
- `overflow: hidden` — 컨테이너 밖으로 넘치는 콘텐츠 방지

---

### Phase 2: 픽셀 비교 스크립트

**파일**: `scripts/compare-screenshots.ts`

```typescript
interface CompareOptions {
  baseImage: string;        // Figma 스크린샷 경로
  currentImage: string;     // 구현 스크린샷 경로
  diffOutput?: string;      // diff 이미지 출력 경로
  threshold?: number;       // pixelmatch threshold (기본: 0.1)
}

interface CompareResult {
  diffPixels: number;
  totalPixels: number;
  diffRatio: number;        // 0~1
  passed: boolean;          // diffRatio <= 0.05 (5%)
  sizeMismatch: boolean;
  baseSize: { width: number; height: number };
  currentSize: { width: number; height: number };
}
```

**[신규] 크기 불일치 경고**:
`normalizeSize()`에서 base와 current의 크기가 다르면 경고를 출력합니다:
```
Size mismatch: base=1264x96, current=1260x96. Resizing current to match base.
```

기존 bilinear interpolation 리사이즈 로직은 1-2px 반올림 오차 대비 안전망으로 유지합니다.

---

### Phase 3: Storybook 설정 수정

**파일**: `.storybook/main.ts`

```typescript
stories: [
  '../src/**/*.mdx',
  '../src/**/*.stories.@(js|jsx|mjs|ts|tsx)',
  '../__screenshots__/**/*.stories.@(js|jsx|mjs|ts|tsx)',  // 추가
],
```

---

### Phase 4-6: SKILL 파일

각 SKILL은 `.claude/skills/` 디렉토리에 SKILL.md로 정의:
- `story-generator`: `/story-gen <컴포넌트 경로>`
- `component-screenshot`: `/screenshot <Story 파일 경로>`
- `design-check`: `/design-check <Figma URL> <컴포넌트 경로>` (오케스트레이션)

---

## 6. 디렉토리 구조

```
MaxGauge-VI/
├── .claude/skills/
│   ├── story-generator/SKILL.md
│   ├── component-screenshot/SKILL.md
│   └── design-check/SKILL.md
├── scripts/
│   ├── capture-screenshot.ts
│   └── compare-screenshots.ts
├── __screenshots__/
│   └── {ComponentName}.screenshot.stories.tsx
├── artifacts/
│   ├── screenshots/
│   │   ├── figma/{ComponentName}.png
│   │   ├── impl/{ComponentName}.png
│   │   └── diff/{ComponentName}.png
│   └── design-check/
│       └── {ComponentName}-report.md
└── .storybook/main.ts
```

---

## 7. 보고서 형식

```markdown
# 디자인 검토 보고서: {ComponentName}

## 정량 비교 결과
| 항목 | 값 |
|------|-----|
| 총 픽셀 | {N} |
| 차이 픽셀 | {N} |
| 차이 비율 | {N}% |
| 판정 | ✅ Pass / ❌ Fail |

## 항목별 점검
| # | 항목 | 상태 | 설명 |
|---|------|------|------|
| 1 | 전체 레이아웃 | ✅/❌/⚠️ | ... |
| 2 | 색상 | ✅/❌/⚠️ | ... |
| 3 | 타이포그래피 | ✅/❌/⚠️ | ... |
...

## 디자인 토큰 비교
| 토큰 | Figma 값 | 코드 값 | 일치 |
|------|----------|---------|------|
...

## 수정 권장사항
1. ...
```

---

## 8. 구현 우선순위

1. **Phase 1** → `capture-screenshot.ts` — 핵심 기반
2. **Phase 2** → `compare-screenshots.ts` — 정량 비교
3. **Phase 3** → `.storybook/main.ts` 수정
4. **Phase 4** → `story-generator` SKILL
5. **Phase 5** → `component-screenshot` SKILL
6. **Phase 6** → `design-check` SKILL — 전체 오케스트레이션
