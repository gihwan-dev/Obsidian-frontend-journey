# 📅 그룹웨어 캘린더 휴가자 알림

## 작업내용
- 매일 오전 9시 30분에 그룹웨어의 캘린더에 등록된 휴가자 팀원의 목록을 matter most 메시지로 받아 볼 수 있도록함

![](https://t25540965.p.clickup-attachments.com/t25540965/37df5412-b8a6-4409-b3f0-e02fea827c55/image.png)

## 구현방법

### 1. Matter Most 의 integration 에 incoming webhook 을 생성
![](https://t25540965.p.clickup-attachments.com/t25540965/37e1551c-bfc6-4f8a-863e-c99c42692f07/image.png)
![](https://t25540965.p.clickup-attachments.com/t25540965/a2b4f3f3-753b-4720-92fd-149a56f789e7/image.png)

### 2. puppeteer 라는 headless browser 를 이용해서

그룹웨어 로그인 > 캘린더 페이지 방문 > 등록된 휴가 데이터 파싱후 웹훅으로 메시지 전송

하는 과정을 수행하는 스크립트 작성

```javascript
const puppeteer = require('puppeteer');
const dayjs = require('dayjs');

(async () => {
    const browser = await puppeteer.launch();
    const page = await browser.newPage();

    // 로그인 프로세스
    await page.goto('https://gw.ex-em.com/login'); // 로그인 페이지 URL
    await page.type('#username', '?????'); // 유저네임 입력
    await page.type('#password', '?????'); // 패스워드 입력
    await page.click('#login_submit'); // 로그인 버튼 클릭
    await page.waitForSelector('#main'); // 페이지 로딩 완료 대기

    // 캘린더 페이지로 이동
    const calendarPage = `https://gw.ex-em.com/app/calendar/daily/${dayjs().format('YYYY-MM-DD')}`;
    await page.goto(calendarPage);
    await page.waitForSelector('#feed-list');
    const guideLayerLayerExists = await page.$('#advancedGuideLayer');
    if (guideLayerLayerExists) {
        await page.click('.welcome_skip');
        await page.waitForSelector('#advancedGuideLayer', { hidden: true });
    }

    // 캘린더 체크박스 클릭
    const coworkerList = ['김보환', '김예린', '배소현', '문성우', '김수진', '윤서연', '김나연', '강지명'];
    for (let name of coworkerList) {
        await page.click(`input[data-name="휴가(${name})"]`)
        await page.waitForTimeout(1000);
    }

    // 특정 DOM 데이터 파싱
    await page.waitForSelector('.day_schedule');
    const eventData = await page.$$eval(
        '.day_schedule .schedule',
            schedules => schedules.map(s=> ({
                info: s.querySelector('.info').textContent,
                name: s.querySelector('.name').textContent,
            })));

    // 메시지 formatting
    const scheduleList = [];
    const scheduleTextList = ['연차', '반차', '공가', '경조휴가'];
    scheduleTextList.forEach(scheduleText => {
        const list = eventData.filter(({ info }) => info === scheduleText)
            .map(({ name }) => name.replace(/\(|\)/g, ''));
        if (list.length > 0) {
            scheduleList.push(`${scheduleText}: ${list.join(', ')}`)
        }
    });
    const text = scheduleList.join('\n');

    // 웹훅으로 데이터 전송
    const webhookUrl = '###########웹훅주소############';
    if (scheduleList.length > 0) {
        await fetch(webhookUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text }),
        });
    }

    await browser.close();
})();
```

### 4. 리눅스환경 message 서버에 기능 추가

- 반반차 제도 시행으로 휴가 일정의 갯수가 많아지므로 매일 아침에만 메시지 전송하는 것으로는 부족하여 기능을 추가함.
- 9:30, 11:30, 14:00, 16:00 마다 메시지를 전송하도록 함.
- group ware 의 calendar 에 반반차 내용에 대한 정보가 부족하므로, 자세한 내용을 메시지로 보낼수는 없고, 이전 시간에 전송했던 내용 외에 추가된 항목만을 메시지로 전송하도록함.

- 로컬 pc 에서 수행했던 작업은 리눅스에서 항시 실행중인 서버가 스크립트를 실행함.
- 서버는 `/calendar` 라는 post 요청을 받으면 스크립트를 수행하도록 함.
- gitLab 의 `Scheduled pipe line` 기능을 이용하여 특정 시간에 `/calendar` post 요청을 트리거하도록함.
- CI/CD 의 variable 에 groupware ID/PW 를 인코딩하여 저장하고 마스킹하도록 해서 기록을 볼수 없으며, 다른 유저는 권한을 developer 로 내려서 variable 에 접근 할수 없도록 함.
- 이전에 알림 메시지로 보냈던 휴가 일정에 대한 정보를 메모리에 갖고 있어야 하므로 서버가 재시작될때 `Scheduled pipe line` 를 gitLab API 로 trigger 1회 함.

## 회고
- 그룹웨어에 api 나 웹훅으로 구현이 가능할것이라 생각해서 시작했지만, 없음..
- ~~로컬 pc 에 스크립트를 두고 이벤트를 생성해둔 것이기 때문에, 개인 pc 가 꺼지면 동작 하지 않음~~ > 공용 환경의 서버로 실행 하도록 하여 항시 구동되도록 함.
- 로그인한 계정에서 확인 가능한 일정만 캘린더에 표시가 되므로, 팀원들에게 휴가 일정에 대한 조회 권한을 먼저 요청해서 받은 상태여야함.

---
*ClickUp 원본: https://app.clickup.com/25540965/docs/rbeb5-443818/rbeb5-1471680*
