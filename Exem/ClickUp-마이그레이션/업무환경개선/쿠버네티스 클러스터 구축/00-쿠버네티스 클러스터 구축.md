# ☸️ 쿠버네티스 클러스터 구축

## 도입 배경
- VM 하나 (10.10.35.62) 의 docker 에 컨테이너를 올려서 프로세스들을 관리하고 있습니다
  - 호스트 자원 문제나 설정 변경시 서비스 중단이 발생하며 CLI 로 수정해야 하므로 본인 외에 수정가능 한 사람이 없음
  - 동적으로 웹서버 추가가 필요한 경우 (MR 마다 테스트 환경 생성 등) 이미지 빌드 및 배포가 어렵습니다.
  - gitlab, jenkins 의 agent 도 한 호스트의 docker 컨테이너로 사용하다보니 CI/CD 작업이 병렬로 실행되지 않습니다

- 위 문제들을 해결하려면 컨테이너 오케스트레이션 환경의 도입이 필요합니다

## 작업 내용

### 쿠버네티스 클러스터로 이용할 VM 생성
- 10.10.35.65~68 번 네트워크 이용하는 vm 4개 생성

### 쿠버네티스 클러스터 구축
- kubespray 를 이용해 클러스터 구축
- ingress 설정, MetalLB 설정
- 가비아에서 fe1exem.xyz 도메인 구매후, DNS 레코드 추가

### 쿠버네티스 사용을 위한 도구 설치
- master node (65번 host) 에 helm 설치
- helm 으로 argocd 를 쿠버네티스 클러스터에 배포

### 쿠버네티스 클러스터에 서비스 배포
- jenkins 에 (mxg 라이브서버, 스토리북) 두가지 아이템 추가
- argocd 연동을 위한 [manifest 프로젝트](http://gitlab.exem.xyz/fe1/k8s-manifests) 추가
- manifest 프로젝트에 라이브서버와 스토리북 헬름 차트 생성

## 서비스 목록
- [ArgoCD](http://argocd.fe1exem.xyz) - admin / exem1234!!
- [Maxgauge VI Live server](http://mxg.fe1exem.xyz)
- [Maxgauge VI Storybook](http://mxgs.fe1exem.xyz)
- [n8n](http://n8n.fe1exem.xyz/)
- [longhorn](https://longhorn.fe1exem.xyz/#/dashboard)
- [open web ui](https://open-webui.fe1exem.xyz/)
- cert-manager
- gitlab-runner-dev
- maxgauge-vi-preview-appset
- reflector

## gitops 설명 링크
- https://coffeewhale.com/kubernetes/gitops/argocd/2020/02/10/gitops-argocd/
- https://heumsi.github.io/blog/posts/argocd-apps-deployment/

## 필요한 개선
- ~~secret 저장 방식 개선~~ - vault 도입 검토했으나 오버엔지니어링으로 판단
- 62번 호스트에서 실행중인 컨테이너를 모두 k8s로 이전
- ~~nexus 나 harbor 구축~~ - 완료
- ~~k8s 모니터링 도구 설치~~ - Prometheus stack 완료
- master, worker 노드 추가 - 현재는 무리없지만 베어메탈의 가용 자원이 많음

## 하위 문서
- [[MR 프리뷰 자동 환경]]
- [[longhorn]]
- [[Prometheus stack]]
- [[Keycloak]]
- [[ArgoCD]]

---
*ClickUp 원본: https://app.clickup.com/25540965/docs/rbeb5-443818/rbeb5-2683018*
