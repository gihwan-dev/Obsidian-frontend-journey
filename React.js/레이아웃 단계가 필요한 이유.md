### 리액트는 어떻게 DOM을 똑똑하게 업데이트할까? - 변형과 레이아웃 단계 이야기
우리가 리액트 코드를 작성하면, 리액트는 가상 DOM(Virtual DOM)을 통해 변경 사항을 계산하고 실제 DOM에 반영합니다. 이 마지막 단계를 '커밋 단계'라고 부릅니다. 흥미로운 점은 리액트가 이 커밋 단계를 단순히 한 번에 처리하는 것이 아니라, **변형(Mutation) 단계**와 **레이아웃(Layout) 단계**라는 두 개의 핵심적인 하위 단계로 나눈다는 것입니다.

처음에는 이런 질문이 들 수 있습니다. "DOM을 변경하면 화면에 요소들이 배치(레이아웃)되는 것은 당연히 브라우저가 하는 일인데, 왜 리액트가 '레이아웃 단계'라는 것을 따로 가지고 있는 걸까?"

이 질문에 대한 답은 바로 **성능 최적화**와 **시각적 일관성**에 있습니다.
#### 1단계: 일단 짓고 보자! - 변형(Mutation) 단계
변형 단계는 리액트가 실제 DOM에 물리적인 변화를 가하는 시간입니다. 새로운 DOM 노드를 추가하고, 기존 노드의 속성을 바꾸고, 더 이상 필요 없는 노드를 제거하는 등의 작업이 모두 여기서 일어납니다. 즉, 브라우저의 **리플로우(Reflow)를 유발하는 모든 행위**가 이 단계에 집중됩니다.

가장 중요한 규칙은, 이 단계에서는 오직 DOM을 **변경(쓰기)만 하고, 절대 측정(읽기)하지 않는다**는 것입니다. 마치 가구를 조립할 때, 일단 설명서에 따라 모든 부품을 조립부터 끝내는 것과 같습니다. 중간에 일일이 줄자로 재면서 조립하지 않는 것처럼 말이죠.

이렇게 '쓰기' 작업을 한데 모아 처리함으로써, 리액트는 브라우저가 불필요하게 여러 번 레이아웃을 다시 계산하는 '레이아웃 스래싱(Layout Thrashing)' 현상을 방지하여 성능을 확보합니다.
#### 2단계: 다 지었으니 재보자! - 레이아웃(Layout) 단계
변형 단계에서 모든 DOM 변경이 완료되면, 이제 레이아웃 단계로 넘어갑니다. 이 단계는 리액트가 브라우저의 레이아웃 계산을 대신하는 것이 아닙니다. 오히려 **브라우저에 의해 모든 변경이 반영된 직후, 그 결과값을 읽고 추가적인 작업을 할 수 있는 '골든타임'**을 갖는 것입니다.

이 단계가 필요한 가장 대표적인 이유는 **화면 깜빡임(Flicker) 현상**을 막기 위해서입니다.

예를 들어, 어떤 버튼을 클릭했을 때 그 옆에 툴팁을 보여줘야 한다고 상상해 봅시다. 툴팁의 정확한 위치를 계산하려면, 툴팁이 DOM에 추가된 후 그 크기와 버튼의 위치를 알아야 합니다.

만약 이 작업을 일반적인 `useEffect`에서 처리한다면 다음과 같은 일이 벌어집니다.

1. 툴팁이 일단 `(0,0)` 같은 기본 위치에 DOM으로 추가됨
2. 브라우저가 **그대로 화면에 그림 (사용자는 툴팁이 엉뚱한 곳에 있는 것을 봄)**
3. `useEffect`가 실행되어 올바른 위치를 계산하고 다시 렌더링
4. 브라우저가 **다시 화면에 그림 (툴팁이 제자리로 순간이동)**

이것이 바로 사용자가 경험하는 '깜빡임'입니다.

하지만 `useLayoutEffect`를 통해 레이아웃 단계에 개입하면, 이 모든 과정이 브라우저가 화면에 최종 그림을 그리기 전에 동기적으로 완료됩니다.

마치 연극 감독이 무대 조명을 켜기 직전, "잠깐!"을 외치고 배우의 위치를 마지막으로 조정한 뒤 관객에게 보여주는 것과 같습니다. 관객은 배우가 처음부터 완벽한 위치에 서 있는 모습만 보게 되는 것이죠.

### 정리하며
결론적으로, 리액트의 두 단계 커밋 전략은 다음과 같이 요약할 수 있습니다.

- **변형(Mutation) 단계:** DOM에 대한 모든 **'쓰기'** 작업을 한 번에 모아서 처리하여 성능을 최적화하는 단계입니다.
- **레이아웃(Layout) 단계:** '쓰기'가 끝난 DOM의 결과물을 **'읽어서'**, 화면에 그려지기 전에 마지막으로 DOM을 조작하여 시각적 완성도를 높이는 단계입니다. (`useLayoutEffect`가 활약하는 무대)

이처럼 리액트는 단순히 DOM을 바꾸는 것을 넘어, 브라우저의 렌더링 흐름에 지능적으로 개입하여 개발자가 더 나은 성능과 안정적인 사용자 경험을 만들 수 있도록 돕고 있습니다.